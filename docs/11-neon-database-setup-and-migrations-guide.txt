=========================================================
NEON DATABASE SETUP & FLASK MIGRATIONS
UNIVERSAL, PRODUCTION-SAFE GUIDE (FINAL)
=========================================================

PURPOSE
-------
‚Ä¢ Use Neon PostgreSQL safely with Flask + Flask-Migrate
‚Ä¢ Handle new Neon accounts, databases, and services correctly
‚Ä¢ Avoid Alembic revision conflicts and production failures
‚Ä¢ Follow the SAME steps every time with ONE clear decision rule

---------------------------------------------------------
GOLDEN ARCHITECTURE RULE (NON-NEGOTIABLE)
---------------------------------------------------------
ONE FLASK SERVICE = ONE NEON DATABASE = ONE ALEMBIC HISTORY

‚úî Same Neon account ‚Üí allowed
‚ùå Same Neon database across services ‚Üí NOT allowed

---------------------------------------------------------
UNIVERSAL FLOW (APPLIES EVERY TIME)
---------------------------------------------------------
These steps are IDENTICAL for:
‚Ä¢ New Neon email
‚Ä¢ New Neon account
‚Ä¢ New project
‚Ä¢ New database
‚Ä¢ New Flask service

Only the DATABASE_URL changes.

---------------------------------------------------------
STEP 1Ô∏è‚É£ : CREATE NEON DATABASE
---------------------------------------------------------
1. Sign up / Log in to Neon
2. Create a Project
3. Create a Database
4. Copy DATABASE_URL

‚úî This database belongs to ONE service only

---------------------------------------------------------
STEP 2Ô∏è‚É£ : LOCAL SETUP (FIRST TIME ONLY)
---------------------------------------------------------
Run inside the Flask project:

flask db init

This creates:
‚Ä¢ migrations/
‚Ä¢ Alembic configuration for THIS service

‚ö†Ô∏è Run ONCE per project only

---------------------------------------------------------
STEP 3Ô∏è‚É£ : LOCAL MODEL CHANGES (DEVELOPMENT)
---------------------------------------------------------
Whenever you change SQLAlchemy models:

flask db migrate -m "describe change"
flask db upgrade

‚úî Applies changes to LOCAL DB only
‚úî Safe to run repeatedly during development

---------------------------------------------------------
STEP 4Ô∏è‚É£ : POINT TO NEON DATABASE (TEMPORARY)
---------------------------------------------------------
PowerShell ONLY (VS Code / Windows):

Sample DB URL format:
$env:DATABASE_URL="postgresql+psycopg://USER:PASSWORD@HOST/DATABASE?sslmode=require"

Pasted Full DB URL:
psql 'postgresql://neondb_owner:npg_g8GbaMwJS7jK@ep-sweet-rain-a1c7rhca-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require'

‚úî Overrides DB only for this terminal session
‚úî Does NOT affect code or GitHub

---------------------------------------------------------
STEP 5Ô∏è‚É£ : APPLY CHANGES TO NEON (DECISION STEP)
---------------------------------------------------------

BEFORE running any command, ask:
üëâ Is the Neon database EMPTY or ALREADY HAS TABLES?

---------------------------------------------------------
CASE A ‚úÖ : FIRST TIME / EMPTY NEON DATABASE
---------------------------------------------------------
Run:

flask db upgrade

This will:
‚úî Create tables
‚úî Create alembic_version
‚úî Apply migrations normally

---------------------------------------------------------
CASE B üî• : NEON DATABASE ALREADY CREATED MANUALLY
---------------------------------------------------------
Run:

flask db stamp <revision_id>

This will:
‚úî Mark migration as applied
‚úî Sync Alembic history
‚úî NOT create tables
‚úî NOT drop or modify data

---------------------------------------------------------
IMPORTANT RULE
---------------------------------------------------------
‚Ä¢ NEVER run flask db migrate on Neon
‚Ä¢ NEVER run upgrade if tables already exist
‚Ä¢ Use stamp ONLY when DB is ahead of Alembic

---------------------------------------------------------
STEP 6Ô∏è‚É£ : CLEANUP (MANDATORY)
---------------------------------------------------------
Always remove the Neon DB URL after DB work:

Remove-Item Env:DATABASE_URL

(or safe one-liner with existence check)

‚úî Prevents accidental DB changes later

---------------------------------------------------------
STEP 7Ô∏è‚É£ : VERIFY (OPTIONAL BUT RECOMMENDED)
---------------------------------------------------------
Neon SQL Editor:

SELECT * FROM alembic_version;

Terminal:

flask db current

Expected:
Current revision(s): <revision_id>

---------------------------------------------------------
WHAT YOU MUST NEVER DO
---------------------------------------------------------
‚ùå Share one database across services
‚ùå Run flask db migrate on cloud DB
‚ùå Reset or drop cloud databases
‚ùå Hardcode DATABASE_URL in code

---------------------------------------------------------
FINAL MENTAL MODEL (MEMORIZE THIS)
---------------------------------------------------------
Local DB  ‚Üí migrate + upgrade
Cloud DB ‚Üí upgrade OR stamp
Manual DB change ‚Üí stamp
One service ‚Üí one database

---------------------------------------------------------
FINAL CONFIRMATION
---------------------------------------------------------
Yes ‚Äî for every new Neon account or database,
the steps are EXACTLY the same.

üîÅ Only the DATABASE_URL changes.
üß† The decision is ONLY between:
   upgrade (empty DB) vs stamp (existing DB)

=========================================================
END OF FILE
=========================================================
