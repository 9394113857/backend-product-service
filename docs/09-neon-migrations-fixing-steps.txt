====================================================
NEON DATABASE â€“ FLASK MIGRATIONS FIX (PRODUCTION SAFE)
====================================================

PURPOSE
-------
â€¢ Fix Alembic migration mismatch when DB was modified manually
â€¢ Safely sync Alembic history with Neon PostgreSQL
â€¢ Avoid duplicate-table and revision errors
â€¢ Follow production-safe migration practices

----------------------------------------------------
BACKGROUND (WHY THIS FILE EXISTS)
----------------------------------------------------
In this project:
â€¢ Tables/columns were created or fixed manually in Neon SQL Editor
â€¢ Alembic migration file exists in code
â€¢ Running `flask db upgrade` caused errors like:
  - DuplicateTable
  - Missing revision
â€¢ This means: DB schema is AHEAD of Alembic history

Correct fix = **STAMP**, not upgrade, not migrate.

----------------------------------------------------
STEP 1ï¸âƒ£ : SET DATABASE_URL (PowerShell ONLY)
----------------------------------------------------
# Temporarily point Flask to Neon PostgreSQL
# This overrides SQLite for THIS terminal session only
# âš ï¸ DO NOT hardcode this in code or commit it

$env:DATABASE_URL="postgresql+psycopg://neondb_owner:npg_8BYrqTPMa1Nn@ep-holy-mouse-a1qipksy-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"

----------------------------------------------------
ğŸ”¥ STEP 2ï¸âƒ£ : THE ONE CORRECT FIX (STAMP)
----------------------------------------------------
# When DB schema already exists but Alembic does not know,
# STAMP tells Alembic:
# â€œYes, this migration is already applied. Donâ€™t recreate anything.â€

RUN THIS (ONLY THIS):

flask db stamp b50946817979

----------------------------------------------------
ğŸ“Œ WHAT STAMP DOES (IMPORTANT)
----------------------------------------------------
âœ” Creates / updates alembic_version table in Neon
âœ” Marks migration `b50946817979` as applied
âœ” Does NOT create tables
âœ” Does NOT modify columns
âœ” Does NOT drop data
âœ” Production-safe

----------------------------------------------------
ğŸ§  WHY STAMP IS THE RIGHT TOOL
----------------------------------------------------

| Situation               | Correct Command        |
|------------------------|------------------------|
| DB behind migration    | flask db upgrade       |
| DB ahead of migration  | flask db stamp         |
| Create migration file  | flask db migrate       |
| Production safety      | upgrade / stamp ONLY   |

----------------------------------------------------
STEP 3ï¸âƒ£ : VERIFY ALEMBIC STATE (OPTIONAL)
----------------------------------------------------
flask db current

EXPECTED OUTPUT:
Current revision(s): b50946817979

----------------------------------------------------
STEP 4ï¸âƒ£ : CLEAN UP (MANDATORY)
----------------------------------------------------
# Remove Neon credentials from terminal session
# Prevents accidental DB changes later

Remove-Item Env:DATABASE_URL

----------------------------------------------------
ğŸ” CONFIRMATION (EXPECTED LOG OUTPUT)
----------------------------------------------------
Context impl PostgresqlImpl.
Running stamp_revision  -> b50946817979

This confirms:
âœ” Connected to Neon PostgreSQL
âœ” Alembic history synced
âœ” No schema changes performed

----------------------------------------------------
ğŸš« WHAT NOT TO DO (VERY IMPORTANT)
----------------------------------------------------
âŒ Do NOT run flask db migrate on Neon
âŒ Do NOT run flask db init again
âŒ Do NOT delete alembic_version
âŒ Do NOT reset cloud DB
âŒ Do NOT retry upgrade after stamp

----------------------------------------------------
ğŸ§  FINAL MENTAL MODEL (MEMORIZE THIS)
----------------------------------------------------
â€¢ Manual DB changes  â†’ flask db stamp
â€¢ Model change (DEV) â†’ flask db migrate
â€¢ Apply to cloud     â†’ flask db upgrade
â€¢ Cloud DB           â†’ NEVER reset

----------------------------------------------------
FINAL STATUS
----------------------------------------------------
âœ” Neon DB schema correct
âœ” Alembic history synced
âœ” Future migrations safe
âœ” No more migration errors

====================================================
END OF FILE
====================================================
